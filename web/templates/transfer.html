{% extends "base.html" %}

{% block header %}
{% include '_header.html' %}

<script type='application/javascript'>
    const params = new URLSearchParams(window.location.search)
    const approvalRequired = params.has('type', 'AccountTransferWorkflowHumanInLoop')

    const listen = () => {
        const eventSource = new FetchEventSource(`/sub/{{id}}`);

        eventSource.addEventListener('open', () => console.log('SSE Open'));
        eventSource.addEventListener('error', (err) => console.log('SSE Error', err));
        eventSource.addEventListener('message', (e) => {
            let data = JSON.parse(e.data)
            console.log('SSE Data received:', data)

            // Clear existing table content
            const tbody = document.querySelector('#workflow-results')

            if (!data || data.length === 0) {
                // Show spinner if no data
                tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-12">
                    <span class="loading loading-spinner loading-lg text-primary"></span>
                </td>
            </tr>
        `
                return
            }

            // Sort data by iteration number (extracted from workflow ID)
            data.sort((a, b) => {
                const iterA = parseInt(a.workflowId.split('-iteration-')[1])
                const iterB = parseInt(b.workflowId.split('-iteration-')[1])
                return iterA - iterB
            });

            tbody.innerHTML = ''

            // Populate table
            data.forEach((item) => {
                const iteration = item.workflowId.split('-iteration-')[1]
                const row = document.createElement('tr')

                // Format timestamp
                const executionTime = new Date(item.executionTimestamp).toLocaleString()

                // Round latency numbers
                const updateLatency = item.updateResponseLatencyMs ?
                    Math.round(item.updateResponseLatencyMs) : 'n/a'
                const workflowLatency = item.workflowResponseLatencyMs ?
                    Math.round(item.workflowResponseLatencyMs) : 'n/a'

                row.innerHTML = `
                    <td class="font-mono">${iteration}</td>
                    <td class="font-mono text-xs">${item.workflowId}</td>
                    <td class="font-mono ${updateLatency !== 'n/a' ? 'text-accent' : 'text-base-content/50'}">
                        ${updateLatency}
                    </td>
                    <td class="font-mono ${workflowLatency !== 'n/a' ? 'text-accent' : 'text-base-content/50'}">
                        ${workflowLatency}
                    </td>
                    <td class="font-mono text-sm">${executionTime}</td>
                `
                tbody.appendChild(row)
            })
        });
    }

    document.addEventListener("DOMContentLoaded", listen);
</script>

<script src="https://cdn.jsdelivr.net/npm/fetch-event-source@1.0.0-alpha.2/index.min.js"></script>

{% endblock header %}

{% block main %}

<div class="flex flex-col gap-8 p-4 rounded-md items-center border border-primary">

    <header class='text-2xl flex-auto w-full flex'>
        <h2 class='text-center w-full flex-auto'>
            <span>Latency Stats</span>
        </h2>
    </header>
    <div class="overflow-x-auto mt-8">
        <table class="table table-zebra">
            <thead>
                <tr>
                    <th>Iteration</th>
                    <th>Workflow ID</th>
                    <th>Update Response Latency (ms)</th>
                    <th>Workflow Response Latency (ms)</th>
                    <th>Execution Time</th>
                </tr>
            </thead>
            <tbody id="workflow-results">
            </tbody>
        </table>
    </div>
</div>


{% endblock main %}

{% block leftcol %}
{% include '_nav.html' %}
{% endblock leftcol %}

{% block rightcol %}
<form action='/approvals/{{id}}' method='post'
    class="approval-form hidden border border-secondary p-4 rounded-md card-normal">
    <fieldset>
        <input type='hidden' name='_METHOD' value='PUT' />
        <button class='btn btn-primary'>Approve Transfer</button>
    </fieldset>
</form>
{% endblock rightcol %}

{% block footer %}
<footer>
    <div></div>
</footer>
{% endblock footer %}